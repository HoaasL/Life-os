<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- å…³é”®ä¿®å¤ï¼šç¦æ­¢ç¼©æ”¾ï¼Œç¡®ä¿æ¯”ä¾‹ 1:1 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LifeOS Mobile | é•¿æœŸä¸»ä¹‰</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        /* ä¿®å¤æ‰‹æœºç«¯ 100vh è¢«åœ°å€æ é®æŒ¡çš„é—®é¢˜ */
        body, #app { 
            height: 100vh; /* Fallback */
            height: 100dvh; /* Modern Mobile Browsers */
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* è¯­éŸ³æ³¢çº¹åŠ¨ç”» */
        .mic-active { animation: pulse 1.5s infinite; background-color: #ef4444 !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* ç§»åŠ¨ç«¯å¡ç‰‡ä¼˜åŒ– */
        .mobile-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="flex w-full h-full relative">
        
        <!-- 1. ç§»åŠ¨ç«¯é®ç½©å±‚ (ç‚¹å‡»ä¾§è¾¹æ å¤–å…³é—­) -->
        <div v-if="showMobileMenu" @click="showMobileMenu = false" class="fixed inset-0 bg-black/50 z-30 md:hidden backdrop-blur-sm transition-opacity"></div>

        <!-- 2. ä¾§è¾¹æ  (æ‰‹æœºç«¯æ»‘å‡ºï¼Œç”µè„‘ç«¯å›ºå®š) -->
        <aside :class="showMobileMenu ? 'translate-x-0' : '-translate-x-full md:translate-x-0'" 
               class="fixed md:relative z-40 w-[75%] md:w-64 h-full bg-slate-900 text-white transition-transform duration-300 ease-in-out flex flex-col shadow-2xl">
            
            <div class="p-6 md:p-8 font-bold text-xl md:text-2xl tracking-wider flex justify-between items-center border-b border-slate-800">
                <span>LifeOS <span class="text-emerald-400">Pro</span></span>
                <!-- æ‰‹æœºç«¯å…³é—­æŒ‰é’® -->
                <button @click="showMobileMenu = false" class="md:hidden text-slate-400 text-2xl">&times;</button>
            </div>

            <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                <template v-for="item in menuItems" :key="item.id">
                    <button @click="switchTab(item.id)" 
                        :class="{'bg-emerald-600 text-white': currentTab===item.id, 'text-slate-300 hover:bg-slate-800': currentTab!==item.id}" 
                        class="w-full p-4 rounded-xl flex items-center gap-4 transition-all active:scale-95">
                        <span class="text-2xl">{{ item.icon }}</span> 
                        <span class="font-medium text-base">{{ item.name }}</span>
                    </button>
                </template>
            </nav>
            
            <div class="p-4 bg-slate-950/50 border-t border-slate-800">
                 <div class="flex items-center gap-2 text-xs text-slate-500 mb-3 justify-center">
                    <span class="w-2 h-2 rounded-full" :class="isCloudSync ? 'bg-green-500' : 'bg-red-500'"></span>
                    {{ isCloudSync ? 'äº‘ç«¯å·²åŒæ­¥' : 'ä»…æœ¬åœ°å­˜å‚¨' }}
                </div>
                <button @click="startDailyReview" class="w-full py-3 bg-indigo-600 rounded-xl font-bold text-sm shadow-lg active:bg-indigo-700 flex justify-center items-center gap-2">
                    ğŸ™ï¸ å¼€å§‹å¤ç›˜
                </button>
            </div>
        </aside>

        <!-- 3. ä¸»å†…å®¹åŒº -->
        <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 w-full">
            
            <!-- é¡¶éƒ¨å¯¼èˆªæ¡ (æ‰‹æœºæ˜¾ç¤ºæ±‰å ¡ï¼Œç”µè„‘æ˜¾ç¤ºæ ‡é¢˜) -->
            <header class="bg-white border-b border-slate-200 h-16 shrink-0 flex items-center justify-between px-4 sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <button @click="showMobileMenu = true" class="md:hidden p-2 -ml-2 text-2xl text-slate-600">
                        â˜°
                    </button>
                    <h2 class="font-bold text-lg text-slate-800 truncate max-w-[200px]">{{ getTabName(currentTab) }}</h2>
                </div>
                <div class="text-xs text-slate-400 font-mono">{{ todayDate }}</div>
            </header>

            <!-- æ»šåŠ¨å†…å®¹å®¹å™¨ -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 pb-24 md:pb-8 no-scrollbar scroll-smooth w-full">
                
                <!-- DASHBOARD -->
                <div v-if="currentTab === 'dashboard'" class="space-y-6">
                    <!-- çŠ¶æ€å¡ç‰‡ -->
                    <div class="grid grid-cols-2 gap-3 md:gap-4">
                        <div class="mobile-card p-4 flex flex-col items-center justify-center py-6">
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wide">ä»Šæ—¥å®Œæˆ</div>
                            <div class="text-4xl font-black text-slate-800 mt-2">{{ completionRate }}%</div>
                        </div>
                        <div class="mobile-card p-4 flex flex-col items-center justify-center py-6">
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-wide">è¿èƒœè®°å½•</div>
                            <div class="text-4xl font-black text-orange-500 mt-2">{{ maxStreak }}</div>
                        </div>
                    </div>

                    <!-- ä¹ æƒ¯åˆ—è¡¨ -->
                    <div class="space-y-3 md:grid md:grid-cols-2 md:gap-6 md:space-y-0 lg:grid-cols-3">
                        <div v-for="(habit, idx) in habits" :key="idx" 
                             class="mobile-card p-5 relative overflow-hidden transition active:scale-[0.98]">
                             <div class="flex items-start justify-between">
                                <div class="flex gap-4 items-center">
                                    <span class="text-3xl bg-slate-50 p-2 rounded-lg">{{ habit.icon }}</span>
                                    <div>
                                        <h3 class="font-bold text-base text-slate-800">{{ habit.name }}</h3>
                                        <p class="text-xs text-slate-400 line-clamp-1">{{ habit.desc }}</p>
                                    </div>
                                </div>
                                <button @click="toggleCheck(idx)" 
                                    class="w-12 h-12 rounded-full border-2 flex items-center justify-center transition-all shadow-sm"
                                    :class="isCheckedToday(habit) ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-200 text-transparent'">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </button>
                             </div>
                             <!-- è¿›åº¦æ¡ -->
                             <div class="mt-4 h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-emerald-500 transition-all duration-500" :style="{width: (habit.streak%7)/7*100 + '%'}"></div>
                             </div>
                        </div>
                        
                        <!-- æ·»åŠ æŒ‰é’® -->
                        <button @click="showPlanModal = true" class="mobile-card p-5 flex items-center justify-center gap-2 text-slate-400 border-dashed hover:text-emerald-600 hover:border-emerald-500 transition">
                            <span class="text-xl">+</span> æ·»åŠ /ç”Ÿæˆè®¡åˆ’
                        </button>
                    </div>
                </div>

                <!-- AI CHAT -->
                <div v-if="currentTab === 'chat'" class="flex flex-col h-[calc(100dvh-140px)] md:h-full bg-white md:rounded-2xl md:border md:shadow-sm">
                    <div class="flex-1 overflow-y-auto p-4 space-y-4" ref="chatContainer">
                        <div v-if="chatHistory.length === 0" class="text-center text-slate-300 mt-20 text-sm">
                            è¿˜æ²¡æœ‰å¯¹è¯ï¼Œç‚¹å‡»å·¦ä¸‹è§’â€œAIè§„åˆ’â€æˆ–ç›´æ¥æé—®ã€‚
                        </div>
                        <div v-for="(msg, i) in chatHistory" :key="i" class="flex flex-col max-w-[90%]" :class="msg.role === 'user' ? 'self-end items-end' : 'self-start items-start'">
                            <div class="p-3 px-4 rounded-2xl text-sm leading-relaxed shadow-sm break-words"
                                 :class="msg.role === 'user' ? 'bg-emerald-600 text-white rounded-br-none' : 'bg-slate-100 text-slate-800 rounded-bl-none'">
                                <span v-html="renderMarkdown(msg.content)"></span>
                            </div>
                            <span class="text-[10px] text-slate-300 mt-1 px-1">{{ msg.time }}</span>
                        </div>
                        <div v-if="isThinking" class="self-start text-xs text-slate-400 animate-pulse pl-2">Thinking...</div>
                    </div>
                    
                    <!-- åº•éƒ¨è¾“å…¥æ  -->
                    <div class="p-3 border-t bg-white flex items-center gap-2">
                         <button @click="toggleVoiceMode" :class="isVoiceActive ? 'mic-active text-white' : 'bg-slate-100 text-slate-600'" class="h-10 w-10 shrink-0 rounded-full flex items-center justify-center transition-all">
                            ğŸ™ï¸
                        </button>
                        <input v-model="userInput" @keyup.enter="sendMessage" type="text" placeholder="è¾“å…¥..." class="flex-1 bg-slate-50 border-0 rounded-full px-4 h-10 text-sm focus:ring-2 focus:ring-emerald-500 outline-none">
                        <button @click="sendMessage" class="h-10 px-4 bg-emerald-600 text-white rounded-full text-sm font-bold shrink-0">å‘é€</button>
                    </div>
                </div>

                <!-- SETTINGS -->
                <div v-if="currentTab === 'settings'" class="space-y-6">
                    <div class="mobile-card p-5">
                        <h3 class="font-bold text-lg mb-4">â˜ï¸ æ•°æ®åŒæ­¥</h3>
                        <div class="space-y-3">
                            <input v-model="supabaseUrl" placeholder="Supabase URL" class="w-full bg-slate-50 border p-3 rounded-lg text-sm">
                            <input v-model="supabaseKey" type="password" placeholder="Supabase Anon Key" class="w-full bg-slate-50 border p-3 rounded-lg text-sm">
                            <button @click="connectSupabase" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold text-sm">è¿æ¥äº‘ç«¯</button>
                        </div>
                    </div>

                    <div class="mobile-card p-5">
                        <h3 class="font-bold text-lg mb-4">ğŸ”‘ AI è®¾ç½®</h3>
                        <div class="space-y-3">
                            <input v-model="apiKey" type="password" placeholder="API Key (sk-...)" class="w-full bg-slate-50 border p-3 rounded-lg text-sm">
                            <input v-model="apiBaseUrl" placeholder="Base URL (e.g. https://api.openai.com/v1)" class="w-full bg-slate-50 border p-3 rounded-lg text-sm">
                        </div>
                        <p class="text-xs text-slate-400 mt-3">è®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜ã€‚</p>
                    </div>
                </div>

            </div>
        </main>

        <!-- æ¨¡æ€æ¡†: ç”Ÿæˆè®¡åˆ’ -->
        <div v-if="showPlanModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-bounce-in">
                <h3 class="text-xl font-bold mb-2">âœ¨ æ·»åŠ è®¡åˆ’</h3>
                <textarea v-model="planPrompt" placeholder="æˆ‘æƒ³ç»ƒå‡ºé©¬ç”²çº¿..." class="w-full h-24 bg-slate-50 rounded-xl p-3 text-sm mb-4 resize-none border-0 focus:ring-2 focus:ring-emerald-500"></textarea>
                <div class="flex gap-2">
                    <button @click="showPlanModal = false" class="flex-1 bg-slate-100 py-3 rounded-xl text-slate-500 font-bold text-sm">å–æ¶ˆ</button>
                    <button @click="generatePlan" :disabled="isThinking" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm">
                        {{ isThinking ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆ' }}
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const currentTab = ref('dashboard');
                const showMobileMenu = ref(false);
                const showPlanModal = ref(false);
                const userInput = ref('');
                const planPrompt = ref('');
                const isThinking = ref(false);
                const isVoiceActive = ref(false);
                
                // Config
                const apiKey = ref(localStorage.getItem('ls_apiKey') || '');
                const apiBaseUrl = ref(localStorage.getItem('ls_apiBaseUrl') || 'https://api.openai.com/v1');
                const supabaseUrl = ref(localStorage.getItem('ls_sbUrl') || '');
                const supabaseKey = ref(localStorage.getItem('ls_sbKey') || '');
                const isCloudSync = ref(false);
                let supabase = null;

                // Data
                const defaultHabits = [
                    { id: 1, name: 'å¥èº«', desc: 'æ ¸å¿ƒåŠ›é‡', icon: 'ğŸ”¥', history: [], streak: 0 },
                    { id: 2, name: 'å­¦ä¹ ', desc: 'n8n è‡ªåŠ¨åŒ–', icon: 'âš¡', history: [], streak: 0 }
                ];
                const habits = ref(JSON.parse(localStorage.getItem('ls_habits')) || defaultHabits);
                const chatHistory = ref(JSON.parse(localStorage.getItem('ls_chat')) || []);

                const menuItems = [
                    { id: 'dashboard', name: 'ä»Šæ—¥çœ‹æ¿', icon: 'ğŸ“Š' },
                    { id: 'chat', name: 'AI æ•™ç»ƒ', icon: 'ğŸ¤–' },
                    { id: 'settings', name: 'è®¾ç½®', icon: 'âš™ï¸' }
                ];

                const todayDate = computed(() => new Date().toLocaleDateString('zh-CN', {month:'short', day:'numeric'}));

                // Actions
                const switchTab = (tab) => {
                    currentTab.value = tab;
                    showMobileMenu.value = false;
                };

                const toggleCheck = (idx) => {
                    const habit = habits.value[idx];
                    const today = new Date().toISOString().split('T')[0];
                    if (habit.history.includes(today)) {
                        habit.history = habit.history.filter(d => d !== today);
                        habit.streak--;
                    } else {
                        habit.history.push(today);
                        habit.streak++;
                    }
                    saveData();
                };

                const isCheckedToday = (habit) => {
                    return habit.history.includes(new Date().toISOString().split('T')[0]);
                };

                // AI & Voice (Simplified for mobile)
                const callAI = async (messages, jsonMode=false) => {
                    if (!apiKey.value) throw new Error("è¯·åœ¨è®¾ç½®ä¸­å¡«å…¥ API Key");
                    const res = await fetch(`${apiBaseUrl.value}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey.value}` },
                        body: JSON.stringify({
                            model: "gpt-3.5-turbo",
                            messages,
                            response_format: jsonMode ? { type: "json_object" } : undefined
                        })
                    });
                    const data = await res.json();
                    return data.choices[0].message.content;
                };

                const sendMessage = async () => {
                    if(!userInput.value.trim()) return;
                    const text = userInput.value;
                    userInput.value = '';
                    chatHistory.value.push({ role: 'user', content: text, time: new Date().toLocaleTimeString().slice(0,5) });
                    isThinking.value = true;
                    nextTick(() => scrollChat());
                    
                    try {
                        const reply = await callAI([
                            { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªçƒ­æƒ…ã€ç®€æ´çš„æ•™ç»ƒã€‚è¯·ç”¨ç®€çŸ­çš„ä¸­æ–‡å›ç­”(ä¸è¶…è¿‡100å­—)ã€‚" },
                            ...chatHistory.value.slice(-6).map(m=>({role:m.role, content:m.content}))
                        ]);
                        chatHistory.value.push({ role: 'assistant', content: reply, time: new Date().toLocaleTimeString().slice(0,5) });
                    } catch(e) {
                        chatHistory.value.push({ role: 'assistant', content: "é”™è¯¯: " + e.message, time: '' });
                    } finally {
                        isThinking.value = false;
                        saveData();
                        nextTick(() => scrollChat());
                    }
                };

                const startDailyReview = () => {
                    switchTab('chat');
                    chatHistory.value.push({ role: 'assistant', content: "ğŸ‘‹ å—¨ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿé‚£äº›ä»»åŠ¡å®Œæˆäº†å—ï¼Ÿ", time: new Date().toLocaleTimeString().slice(0,5) });
                    toggleVoiceMode();
                };

                // Voice Logic
                let recognition;
                const toggleVoiceMode = () => {
                    if (!('webkitSpeechRecognition' in window)) return alert("è¯·ä½¿ç”¨ Chrome/Safari");
                    if (isVoiceActive.value) {
                        recognition.stop();
                        isVoiceActive.value = false;
                    } else {
                        recognition = new webkitSpeechRecognition();
                        recognition.lang = 'zh-CN';
                        recognition.onstart = () => isVoiceActive.value = true;
                        recognition.onend = () => isVoiceActive.value = false;
                        recognition.onresult = (e) => {
                            userInput.value = e.results[0][0].transcript;
                            sendMessage();
                        };
                        recognition.start();
                    }
                };

                const generatePlan = async () => {
                    if(!planPrompt.value) return;
                    isThinking.value = true;
                    try {
                        const res = await callAI([
                            { role: "system", content: "åªè¾“å‡ºJSON: {\"habits\":[{\"name\":\"X\",\"desc\":\"Y\",\"icon\":\"Z\"}]}" },
                            { role: "user", content: `ç›®æ ‡:${planPrompt.value}. æ‹†è§£ä¸º1-2ä¸ªæ¯æ—¥ä¹ æƒ¯` }
                        ], true);
                        const newHabits = JSON.parse(res).habits;
                        newHabits.forEach(h => habits.value.push({...h, history:[], streak:0}));
                        showPlanModal.value = false;
                        planPrompt.value = '';
                    } catch(e) { alert("ç”Ÿæˆå¤±è´¥"); }
                    isThinking.value = false;
                    saveData();
                };

                // Utils
                const renderMarkdown = (text) => marked.parse(text);
                const scrollChat = () => {
                    const c = document.querySelector('.overflow-y-auto'); // Rough selector for chat box
                    if(c) c.scrollTop = c.scrollHeight;
                };
                const getTabName = (id) => menuItems.find(i=>i.id===id).name;
                const completionRate = computed(() => {
                    if(!habits.value.length) return 0;
                    return Math.round((habits.value.filter(isCheckedToday).length / habits.value.length) * 100);
                });
                const maxStreak = computed(() => Math.max(0, ...habits.value.map(h=>h.streak||0)));

                // Sync
                const connectSupabase = async () => {
                    if(!supabaseUrl.value) return;
                    try {
                        supabase = window.supabase.createClient(supabaseUrl.value, supabaseKey.value);
                        const { data } = await supabase.from('user_data').select('*').limit(1);
                        if(data) {
                            isCloudSync.value = true;
                            if(data.length) { habits.value = data[0].habits; chatHistory.value = data[0].chat_history; }
                            localStorage.setItem('ls_sbUrl', supabaseUrl.value);
                            localStorage.setItem('ls_sbKey', supabaseKey.value);
                            alert("å·²è¿æ¥");
                        }
                    } catch(e) { alert("è¿æ¥å¤±è´¥"); }
                };

                const saveData = async () => {
                    localStorage.setItem('ls_habits', JSON.stringify(habits.value));
                    localStorage.setItem('ls_chat', JSON.stringify(chatHistory.value));
                    localStorage.setItem('ls_apiKey', apiKey.value);
                    localStorage.setItem('ls_apiBaseUrl', apiBaseUrl.value);
                    
                    if(isCloudSync.value && supabase) {
                        await supabase.from('user_data').upsert({ id: 1, habits: habits.value, chat_history: chatHistory.value, updated_at: new Date() });
                    }
                };

                watch([apiKey, apiBaseUrl], saveData);
                onMounted(() => {
                    if(supabaseUrl.value) connectSupabase();
                });

                return {
                    currentTab, menuItems, switchTab, getTabName, showMobileMenu, todayDate,
                    habits, isCheckedToday, toggleCheck, completionRate, maxStreak,
                    chatHistory, userInput, sendMessage, isThinking, renderMarkdown, 
                    isVoiceActive, toggleVoiceMode, startDailyReview,
                    showPlanModal, planPrompt, generatePlan,
                    apiKey, apiBaseUrl, supabaseUrl, supabaseKey, connectSupabase, isCloudSync
                };
            }
        }).mount('#app');
    </script>
</body>
</html>