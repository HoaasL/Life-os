<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LifeOS V6.5 | é•¿æœŸä¸»ä¹‰</title>
    
    <!-- æ ¸å¿ƒåº“ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <link href="https://cdn.bootcdn.net/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- ä¿®å¤ï¼šä½¿ç”¨å®˜æ–¹ç¨³å®šçš„ Supabase CDN (UMDç‰ˆæœ¬)ï¼Œç¡®ä¿ window.supabase å¯ç”¨ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh; 
            overflow: hidden; 
            color: #1f2937;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }

        .hover-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .hover-card:active { transform: scale(0.98); }

        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease, opacity 0.3s; }
        .slide-enter-from, .slide-leave-to { transform: translateX(100%); opacity: 0; }
        
        .voice-wave { display: inline-block; width: 4px; height: 10px; background: white; margin: 0 2px; animation: wave 1s infinite ease-in-out; border-radius: 5px; }
        .voice-wave:nth-child(2) { animation-delay: 0.1s; } 
        .voice-wave:nth-child(3) { animation-delay: 0.2s; }
        @keyframes wave { 0%, 100% { height: 10px; } 50% { height: 25px; } }
        
        .progress-ring-circle { transition: stroke-dasharray 0.5s ease-in-out; }
    </style>
</head>
<body>

<div id="app" class="relative w-full h-full flex flex-col">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="glass h-16 flex items-center justify-between px-5 flex-shrink-0 z-20">
        <div class="font-bold text-xl tracking-tight flex items-center gap-2 text-slate-800">
            <span class="bg-indigo-600 text-white w-8 h-8 rounded-lg flex items-center justify-center shadow-md"><i class="fa-solid fa-leaf"></i></span>
            LifeOS
        </div>
        <div class="flex gap-4 text-sm">
             <div v-if="syncStatus" class="flex items-center gap-1 text-xs font-medium" :class="syncStatus.includes('æˆåŠŸ') || syncStatus.includes('å·²è¿æ¥') ? 'text-green-600':'text-yellow-600'">
                <i class="fa-solid fa-cloud"></i> {{ syncStatus }}
             </div>
             <button @click="currentView = 'settings'" class="text-gray-500 hover:text-indigo-600 transition p-2"><i class="fa-solid fa-gear text-lg"></i></button>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-1 overflow-hidden relative">
        
        <!-- 1. çœ‹æ¿ -->
        <div v-if="currentView === 'dashboard'" class="h-full overflow-y-auto p-5 space-y-8 no-scrollbar pb-32">
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-1">{{ todayDate }}</h2>
                    <h1 class="text-3xl font-extrabold text-gray-800">å¼€å§‹ä½ çš„è¿›åŒ–</h1>
                </div>
                <button @click="startVoiceReview" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-5 py-2.5 rounded-full text-sm font-bold shadow-lg transform active:scale-95 transition flex items-center gap-2 hover:shadow-xl">
                    <i class="fa-solid fa-microphone"></i> æ•™ç»ƒå¤ç›˜
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                <div v-for="project in projects" :key="project.id" @click="openProject(project)"
                     class="hover-card bg-white rounded-2xl p-6 shadow-sm border border-gray-100 relative overflow-hidden cursor-pointer group hover:shadow-md hover:border-indigo-100">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <span class="text-4xl bg-gray-50 w-16 h-16 rounded-2xl flex items-center justify-center shadow-inner">{{ project.icon }}</span>
                            <div>
                                <h3 class="font-bold text-lg text-gray-800 group-hover:text-indigo-600 transition">{{ project.name }}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs font-medium bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">
                                        {{ getPendingCount(project) }} å¾…åŠ
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="relative w-12 h-12 flex items-center justify-center">
                            <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36">
                                <path class="text-gray-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" />
                                <path class="text-indigo-500 progress-ring-circle" :stroke-dasharray="getProgress(project) + ', 100'" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" />
                            </svg>
                            <span class="absolute text-xs font-bold text-indigo-600">{{ getProgress(project) }}%</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 line-clamp-2 h-10">{{ project.desc }}</p>
                </div>

                <button @click="startPlanning" class="border-2 border-dashed border-gray-300 rounded-2xl p-6 flex flex-col items-center justify-center text-gray-400 hover:border-indigo-400 hover:text-indigo-500 hover:bg-white transition min-h-[160px] group">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3 group-hover:bg-indigo-50 transition">
                        <i class="fa-solid fa-plus text-xl"></i>
                    </div>
                    <span class="text-sm font-medium">AI ä¸“å®¶å’¨è¯¢ç«‹é¡¹</span>
                </button>
            </div>
        </div>

        <!-- 2. è¯¦æƒ…é¡µ -->
        <transition name="slide">
            <div v-if="currentView === 'detail' && activeProject" class="absolute inset-0 bg-gray-50 z-10 flex flex-col h-full">
                <div class="glass h-16 flex items-center justify-between px-4 flex-shrink-0">
                    <button @click="currentView = 'dashboard'" class="text-gray-500 hover:text-gray-900 px-2 py-1 rounded-lg hover:bg-gray-100 transition flex items-center gap-1">
                        <i class="fa-solid fa-arrow-left"></i> è¿”å›
                    </button>
                    <div class="font-bold text-lg">{{ activeProject.name }}</div>
                    <button @click="toggleEdit" :class="isEditing?'text-indigo-600 bg-indigo-50':'text-gray-500'" class="text-sm px-3 py-1.5 rounded-lg font-medium transition">
                        {{ isEditing?'å®Œæˆ':'ç¼–è¾‘' }}
                    </button>
                </div>

                <div class="p-4 flex-shrink-0 bg-white shadow-sm z-10">
                    <div class="flex bg-gray-100 p-1 rounded-xl">
                        <button @click="detailTab='todo'" :class="detailTab==='todo'?'bg-white shadow text-indigo-600':'text-gray-500 hover:text-gray-700'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all">
                            <i class="fa-solid fa-list-check mr-1"></i> æ¯æ—¥è¡ŒåŠ¨
                        </button>
                        <button @click="detailTab='timeline'" :class="detailTab==='timeline'?'bg-white shadow text-indigo-600':'text-gray-500 hover:text-gray-700'" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all">
                            <i class="fa-solid fa-clock-rotate-left mr-1"></i> å¤ç›˜æ—¶å…‰è½´
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-5 no-scrollbar">
                    <div v-if="detailTab === 'todo'" class="space-y-3 pb-20">
                        <div v-if="!isEditing && getPendingCount(activeProject) === 0" class="text-center py-20 opacity-50">
                            <i class="fa-solid fa-mug-hot text-4xl mb-4 text-gray-300"></i>
                            <p>å¤ªæ£’äº†ï¼ä»Šæ—¥ä»»åŠ¡å·²å…¨éƒ¨æ¸…ç©º</p>
                        </div>

                        <div v-for="(action, idx) in activeProject.actions" :key="idx">
                            <div v-if="!action.done || isEditing" class="flex gap-4 items-start bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition">
                                <button v-if="!isEditing" @click="markDone(action)" class="mt-1 w-6 h-6 rounded-full border-2 border-gray-300 hover:border-indigo-500 hover:bg-indigo-50 transition flex-shrink-0"></button>
                                <button v-else @click="deleteAction(idx)" class="mt-1 text-red-400 hover:bg-red-50 p-1 rounded"><i class="fa-solid fa-minus-circle"></i></button>
                                <div class="flex-1">
                                    <div v-if="!isEditing" class="text-gray-800 font-medium leading-relaxed">{{ action.title }}</div>
                                    <input v-else v-model="action.title" class="w-full border-b-2 border-indigo-100 focus:border-indigo-500 outline-none py-1 bg-transparent">
                                </div>
                            </div>
                        </div>
                        
                        <button v-if="isEditing" @click="activeProject.actions.push({title:'æ–°è¡ŒåŠ¨', done:false, insight:'', date:''})" class="w-full py-4 text-gray-400 border-2 border-dashed border-gray-300 rounded-xl hover:border-indigo-400 hover:text-indigo-500 transition font-bold text-sm mt-4">
                            + æ·»åŠ æ–°è¡ŒåŠ¨
                        </button>
                    </div>

                    <div v-if="detailTab === 'timeline'" class="space-y-8 relative pl-2 pb-20">
                        <div class="absolute left-[21px] top-4 bottom-0 w-0.5 bg-gray-200"></div>
                        
                        <div v-for="(action, idx) in getDoneActions(activeProject)" :key="idx" class="relative pl-10 group">
                            <div class="absolute left-0 top-0 w-11 h-11 flex flex-col items-center z-10 bg-gray-50">
                                <div class="w-4 h-4 rounded-full bg-green-500 ring-4 ring-white shadow-sm group-hover:scale-110 transition"></div>
                            </div>
                            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 hover:shadow-md transition">
                                <div class="flex justify-between items-start mb-3">
                                    <h4 class="font-bold text-gray-800 text-sm line-through text-gray-400">{{ action.title }}</h4>
                                    <span class="text-xs text-gray-400 font-mono bg-gray-50 px-2 py-1 rounded">{{ action.date }}</span>
                                </div>
                                <div class="bg-indigo-50 p-4 rounded-lg text-sm text-gray-700 relative leading-relaxed">
                                    <i class="fa-solid fa-quote-left text-indigo-200 absolute -top-2 -left-2 text-2xl"></i>
                                    <p v-if="action.insight">{{ action.insight }}</p>
                                    <div v-else class="flex justify-between items-center text-gray-400 italic">
                                        <span>æœªè®°å½•æ„Ÿæ‚Ÿ</span>
                                        <button @click="replenishInsight(action)" class="text-indigo-600 font-bold hover:underline">å»è¡¥å†™</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div v-if="getDoneActions(activeProject).length === 0" class="text-center py-20 text-gray-400">
                            è¿˜æ²¡æœ‰å®Œæˆè®°å½•ï¼Œå¿«å»â€œæ¯æ—¥è¡ŒåŠ¨â€æ‰“å¡å§ï¼
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 3. è®¾ç½®é¡µé¢ -->
        <div v-if="currentView === 'settings'" class="p-6 bg-gray-50 h-full overflow-y-auto">
            <button @click="currentView = 'dashboard'" class="mb-6 text-gray-500 hover:text-gray-900 flex items-center gap-2 font-bold"><i class="fa-solid fa-arrow-left"></i> è¿”å›</button>
            <h2 class="font-bold text-2xl mb-8 text-gray-800">è®¾ç½®ä¸è¿æ¥</h2>
            
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">ğŸ§  AI å¤§è„‘é…ç½®</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">API Base URL</label>
                        <input v-model="apiBaseUrl" placeholder="https://api.deepseek.com" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">API Key</label>
                        <input v-model="apiKey" type="password" placeholder="sk-..." class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Model Name</label>
                        <input v-model="apiModel" placeholder="deepseek-chat" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition">
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4"â˜ï¸ äº‘ç«¯åŒæ­¥ (Supabase)</h3>
                <div class="space-y-4">
                    <input v-model="supabaseUrl" placeholder="Project URL" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm outline-none">
                    <input v-model="supabaseKey" type="password" placeholder="Anon Key" class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl text-sm outline-none">
                    <button @click="initSupabase" class="w-full bg-gray-900 text-white py-3 rounded-xl text-sm font-bold hover:bg-black transition shadow-lg">è¿æ¥äº‘ç«¯</button>
                </div>
            </div>
            
            <div class="mt-8 text-center">
                <button @click="resetData" class="text-red-500 text-sm hover:underline">é‡ç½®æ¼”ç¤ºæ•°æ®</button>
            </div>
        </div>

    </main>

    <!-- AI å’¨è¯¢å®¤å¼¹çª— -->
    <div v-if="showPlanningModal" class="fixed inset-0 bg-gray-900 z-50 flex flex-col">
        <div class="h-16 bg-gray-800 text-white flex items-center justify-between px-5 flex-shrink-0 shadow-lg">
            <span class="font-bold flex items-center gap-2 text-lg"><i class="fa-solid fa-user-doctor text-indigo-400"></i> ç›®æ ‡å’¨è¯¢å®¤</span>
            <button @click="closePlanning" class="text-gray-400 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-700 transition"><i class="fa-solid fa-times text-xl"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-5 space-y-6 bg-gray-50" ref="chatContainer">
            <div v-if="planningMessages.length === 0" class="text-center text-gray-400 mt-20 text-sm animate-pulse">
                <div class="text-6xl mb-6">ğŸ©º</div>
                <p class="text-lg text-gray-600 font-bold mb-2">æˆ‘æ˜¯ä½ çš„ AI è§„åˆ’å¸ˆ</p>
                <p>å‘Šè¯‰æˆ‘ä½ çš„ç›®æ ‡ï¼Œæˆ‘ä¼šå…ˆè¯„ä¼°å¯è¡Œæ€§ï¼Œ<br>å†ä¸ºä½ é‡èº«å®šåˆ¶è®¡åˆ’ã€‚</p>
            </div>
            
            <div v-for="(msg, i) in planningMessages" :key="i" class="flex flex-col max-w-[90%] md:max-w-xl" :class="msg.role==='user'?'self-end items-end':'self-start items-start'">
                <div class="p-4 rounded-2xl text-sm leading-relaxed shadow-sm break-words relative"
                     :class="msg.role==='user'?'bg-indigo-600 text-white rounded-br-none':'bg-white text-gray-800 rounded-bl-none border border-gray-200'">
                    {{ msg.content }}
                </div>
            </div>
            
            <div v-if="isThinking" class="self-start flex items-center gap-2 text-gray-400 text-xs pl-2">
                <i class="fa-solid fa-circle-notch fa-spin"></i> ä¸“å®¶æ­£åœ¨æ€è€ƒ...
            </div>
        </div>

        <div class="p-4 bg-white border-t border-gray-200 flex flex-col gap-3 pb-6 md:pb-4">
            <div v-if="planningMessages.length > 2" class="flex justify-center">
                 <button @click="finalizePlan" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-4 py-2 rounded-full border border-indigo-100 hover:bg-indigo-100 transition animate-bounce">
                    âœ¨ ä¿¡æ¯å·²è¶³å¤Ÿï¼Œç”Ÿæˆè®¡åˆ’
                </button>
            </div>
            <div class="flex gap-3 items-end">
                <textarea v-model="planInput" @keydown.enter.prevent="sendPlanningMessage" placeholder="è¾“å…¥ä½ çš„å›ç­”..." class="flex-1 bg-gray-100 border-0 rounded-2xl p-4 text-sm max-h-32 outline-none focus:ring-2 focus:ring-indigo-500 transition"></textarea>
                <button @click="sendPlanningMessage" :disabled="isThinking" class="bg-indigo-600 text-white h-12 px-6 rounded-2xl text-sm font-bold flex-shrink-0 disabled:opacity-50 hover:bg-indigo-700 transition shadow-md">å‘é€</button>
            </div>
        </div>
    </div>

    <!-- æ„Ÿæ‚Ÿå¼¹çª— -->
    <div v-if="showInsightModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-50 flex items-end md:items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full md:max-w-md md:rounded-3xl rounded-t-3xl p-8 shadow-2xl transform transition-transform">
            <div class="flex items-center gap-3 mb-4 text-green-600">
                <i class="fa-solid fa-circle-check text-2xl"></i>
                <h3 class="font-bold text-xl text-gray-800">æ‰“å¡æˆåŠŸï¼</h3>
            </div>
            <p class="text-sm text-gray-500 mb-4">è¶çƒ­æ‰“é“ï¼Œè®°å½•ä¸€ä¸‹åˆšæ‰çš„è¡ŒåŠ¨æ„Ÿæ‚Ÿå§ï¼Ÿ</p>
            
            <textarea v-model="tempInsight" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©å‘ç°èƒŒå•è¯ç»“åˆä¾‹å¥æ•ˆæœæ›´å¥½..." class="w-full h-32 bg-gray-50 border border-gray-200 p-4 rounded-2xl text-sm mb-6 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition resize-none"></textarea>
            
            <div class="flex justify-between items-center">
                <button @click="toggleMicForInsight" :class="isMicListening?'bg-red-500 text-white animate-pulse':'bg-gray-100 text-gray-600 hover:bg-gray-200'" class="w-12 h-12 rounded-full flex items-center justify-center transition shadow-sm">
                    <i class="fa-solid fa-microphone text-lg"></i>
                </button>
                <div class="flex gap-3">
                    <button @click="saveInsight(true)" class="text-gray-400 text-sm px-4 font-medium hover:text-gray-600">è·³è¿‡</button>
                    <button @click="saveInsight(false)" class="bg-indigo-600 text-white px-8 py-3 rounded-xl text-sm font-bold shadow-lg hover:bg-indigo-700 hover:shadow-xl transition transform active:scale-95">ä¿å­˜è®°å½•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯­éŸ³æ•™ç»ƒå…¨å± -->
    <div v-if="isVoiceReviewing" class="fixed inset-0 z-50 bg-indigo-900 bg-opacity-95 flex flex-col items-center justify-center p-6 text-white text-center backdrop-blur-md">
        <button @click="endVoiceReview" class="absolute top-8 right-8 text-indigo-300 text-3xl hover:text-white transition">&times;</button>
        
        <div class="w-24 h-24 bg-indigo-800 rounded-full flex items-center justify-center mb-8 shadow-2xl border-4 border-indigo-700">
            <span class="text-5xl">ğŸ¤–</span>
        </div>
        
        <p class="text-2xl font-bold leading-relaxed max-w-md mb-12 min-h-[80px]">{{ aiSpeakingText || 'æˆ‘åœ¨å¬...' }}</p>
        
        <div class="h-12 mb-8 flex items-center justify-center">
            <div v-if="voiceState==='listening'" class="flex gap-1.5">
                <span class="voice-wave"></span><span class="voice-wave"></span><span class="voice-wave"></span><span class="voice-wave"></span><span class="voice-wave"></span>
            </div>
        </div>
        
        <button @click="toggleCoachMic" :class="voiceState==='listening'?'bg-red-500 scale-110 shadow-red-900/50':'bg-indigo-600 hover:bg-indigo-500'" class="w-24 h-24 rounded-full flex items-center justify-center text-3xl shadow-2xl transition-all border-4 border-white/10">
            <i class="fa-solid" :class="voiceState==='listening'?'fa-stop':'fa-microphone'"></i>
        </button>
        <p class="mt-6 text-indigo-300 text-sm font-medium">{{ voiceState==='listening' ? 'ç‚¹å‡»åœæ­¢' : 'ç‚¹å‡»è¯´è¯' }}</p>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // --- Config (è‡ªåŠ¨ä» localStorage è¯»å–) ---
            const apiKey = ref(localStorage.getItem('ls_apiKey') || '');
            const apiBaseUrl = ref(localStorage.getItem('ls_apiBaseUrl') || 'https://api.deepseek.com');
            const apiModel = ref(localStorage.getItem('ls_apiModel') || 'deepseek-chat');
            const supabaseUrl = ref(localStorage.getItem('ls_sbUrl') || '');
            const supabaseKey = ref(localStorage.getItem('ls_sbKey') || '');
            let supabase = null;

            // --- State ---
            const currentView = ref('dashboard');
            const detailTab = ref('todo');
            const activeProject = ref(null);
            const activeAction = ref(null);
            const showPlanningModal = ref(false);
            const showInsightModal = ref(false);
            const isEditing = ref(false);
            const tempInsight = ref('');
            const syncStatus = ref('');
            
            // Planning
            const planInput = ref('');
            const planningMessages = ref([]);
            const isThinking = ref(false);

            // ç¤ºä¾‹æ•°æ®
            const exampleData = [
                {
                    id: 1,
                    name: 'é›¶åŸºç¡€è‹±è¯­çªå‡»',
                    icon: 'ğŸ‡ºğŸ‡¸',
                    desc: 'ç›®æ ‡ï¼š3ä¸ªæœˆåèƒ½è¿›è¡Œæ—¥å¸¸æ— éšœç¢å¯¹è¯ï¼Œé‡ç‚¹çªç ´å£è¯­',
                    actions: [
                        { title: 'èƒŒè¯µ New Concept English ç¬¬ä¸€è¯¾', done: true, date: '12æœˆ10æ—¥', insight: 'å‘ç°è¿è¯»æ˜¯æœ€å¤§çš„éšœç¢ï¼Œæ˜å¤©è¦ä¸“é—¨ç»ƒä¸€ä¸‹åéŸ³æŠ€å·§ã€‚' },
                        { title: 'å¤šé‚»å›½æ‰“å¡ 15 åˆ†é’Ÿ', done: false, insight: '', date: '' },
                        { title: 'è§‚çœ‹ä¸€é›†ã€Šè€å‹è®°ã€‹ä¸å¸¦å­—å¹•', done: false, insight: '', date: '' },
                        { title: 'è·Ÿè¯» CNN News 10åˆ†é’Ÿ', done: false, insight: '', date: '' }
                    ]
                },
                {
                    id: 2,
                    name: 'å‡è„‚å¡‘å½¢è®¡åˆ’',
                    icon: 'ğŸ”¥',
                    desc: 'ä½“è„‚ç‡ä» 25% é™åˆ° 18%ï¼Œæ¯å‘¨3æ¬¡åŠ›é‡è®­ç»ƒ',
                    actions: [
                        { title: 'å¸•æ¢…æ‹‰ HIIT 20åˆ†é’Ÿ', done: true, date: '12æœˆ11æ—¥', insight: 'å¿ƒç‡ä¸€åº¦é£™åˆ°160ï¼Œå¤ªç´¯äº†ï¼Œä½†å‡ºæ±—çš„æ„Ÿè§‰å¾ˆçˆ½ï¼' },
                        { title: 'æ§åˆ¶æ™šé¤ç¢³æ°´æ‘„å…¥', done: false, insight: '', date: '' },
                        { title: 'æ·±è¹² 4ç»„ x 12æ¬¡', done: false, insight: '', date: '' }
                    ]
                }
            ];

            const projects = ref(JSON.parse(localStorage.getItem('ls_projects_v5') || 'null') || exampleData);

            // --- Helpers ---
            const todayDate = computed(() => new Date().toLocaleDateString('zh-CN', {month:'long', day:'numeric', weekday:'long'}));
            const getProgress = (p) => !p.actions.length ? 0 : Math.round((p.actions.filter(a=>a.done).length / p.actions.length) * 100);
            const getPendingCount = (p) => p.actions.filter(a=>!a.done).length;
            const getDoneActions = (p) => p.actions.filter(a=>a.done).reverse();
            
            const openProject = (p) => { activeProject.value = p; currentView.value = 'detail'; detailTab.value = 'todo'; isEditing.value=false; };
            const toggleEdit = () => { isEditing.value = !isEditing.value; if(!isEditing.value) saveData(); };
            const resetData = () => { if(confirm("ç¡®å®šé‡ç½®ä¸ºæ¼”ç¤ºæ•°æ®å—ï¼Ÿå½“å‰æ•°æ®å°†ä¸¢å¤±ã€‚")){ localStorage.removeItem('ls_projects_v5'); location.reload(); } };

            // --- API Logic ---
            const callAI = async (messages, jsonMode=false) => {
                if (!apiKey.value) { alert("è¯·å…ˆå»è®¾ç½®é¡µå¡«å…¥ API Key"); return null; }
                let url = apiBaseUrl.value.trim().replace(/\/+$/, '');
                if (url.includes('deepseek.com') && !url.includes('chat/completions')) url = `${url}/chat/completions`;
                else if (!url.includes('chat/completions')) { if (!url.endsWith('/v1')) url += '/v1'; url += '/chat/completions'; }

                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey.value}` },
                        body: JSON.stringify({ model: apiModel.value, messages, response_format: jsonMode ? { type: "json_object" } : undefined })
                    });
                    if (!res.ok) throw new Error(await res.text());
                    const data = await res.json();
                    return data.choices[0].message.content;
                } catch(e) { alert(`AI Error: ${e.message}`); return null; }
            };

            // --- Planning ---
            const startPlanning = () => { showPlanningModal.value = true; planningMessages.value = []; planInput.value = ''; };
            const closePlanning = () => { if(confirm("ç¡®å®šé€€å‡ºï¼Ÿ")) showPlanningModal.value = false; };
            const sendPlanningMessage = async () => {
                if (!planInput.value.trim()) return;
                const userText = planInput.value;
                planningMessages.value.push({ role: 'user', content: userText });
                planInput.value = '';
                isThinking.value = true;
                await nextTick();
                const c = document.querySelector('.fixed.inset-0 .overflow-y-auto');
                if(c) c.scrollTop = c.scrollHeight;
                const context = [{ role: "system", content: "ä½ æ˜¯ä¸€ä¸ªç›®æ ‡ä¸“å®¶ã€‚å…ˆè¯Šæ–­ï¼Œå¤šé—®ç»†èŠ‚ã€‚æœ€åæ‰ç”Ÿæˆè®¡åˆ’ã€‚" }, ...planningMessages.value];
                const reply = await callAI(context, false);
                if (reply) planningMessages.value.push({ role: 'assistant', content: reply });
                isThinking.value = false;
                await nextTick();
                if(c) c.scrollTop = c.scrollHeight;
            };
            const finalizePlan = async () => {
                isThinking.value = true;
                const context = [...planningMessages.value, { role: "user", content: "è¯·ç”ŸæˆJSON: { \"name\": \"é¡¹ç›®å\", \"icon\": \"emoji\", \"desc\": \"ä¸€å¥è¯æè¿°\", \"actions\": [ {\"title\": \"åŠ¨ä½œ\"} ] }" }];
                const res = await callAI(context, true);
                if (res) {
                    try {
                        const data = JSON.parse(res);
                        projects.value.push({ id: Date.now(), name: data.name, icon: data.icon, desc: data.desc || "AI å®šåˆ¶", actions: data.actions.map(a => ({ title: a.title, done: false, insight: '', date: '' })) });
                        showPlanningModal.value = false;
                        alert("è®¡åˆ’å·²ç”Ÿæˆï¼");
                        saveData();
                    } catch(e) { alert("è§£æå¤±è´¥"); }
                }
                isThinking.value = false;
            };

            // --- Action & Persistence ---
            const markDone = (a) => { activeAction.value = a; showInsightModal.value = true; tempInsight.value = ''; };
            const saveInsight = (skip) => {
                if(activeAction.value) {
                    activeAction.value.done = true;
                    activeAction.value.date = new Date().toLocaleDateString();
                    if(!skip) activeAction.value.insight = tempInsight.value;
                }
                saveData();
                showInsightModal.value = false;
                setTimeout(()=>detailTab.value='timeline', 300);
            };
            const deleteAction = (i) => activeProject.value.actions.splice(i, 1);
            const replenishInsight = (a) => { activeAction.value = a; tempInsight.value = a.insight; showInsightModal.value = true; };

            const saveData = async () => {
                // æœ¬åœ°æŒä¹…åŒ–ï¼šé¡¹ç›® + AI/Supabase é…ç½®
                localStorage.setItem('ls_projects_v5', JSON.stringify(projects.value));
                localStorage.setItem('ls_apiKey', apiKey.value);
                localStorage.setItem('ls_apiBaseUrl', apiBaseUrl.value);
                localStorage.setItem('ls_apiModel', apiModel.value);
                localStorage.setItem('ls_sbUrl', supabaseUrl.value);
                localStorage.setItem('ls_sbKey', supabaseKey.value);

                if (supabase) {
                    syncStatus.value = 'åŒæ­¥ä¸­...';
                    const { error } = await supabase
                        .from('user_data')
                        .upsert({ id: 1, projects: projects.value, updated_at: new Date().toISOString() });
                    
                    if (error) {
                         console.error('Supabase Sync Error:', error);
                         syncStatus.value = 'åŒæ­¥å¤±è´¥';
                    } else {
                         syncStatus.value = 'åŒæ­¥æˆåŠŸ';
                    }
                }
            };

            const initSupabase = async () => {
                if (!supabaseUrl.value || !supabaseKey.value) {
                    alert('è¯·å¡«å†™å®Œæ•´ Supabase Project URL å’Œ Anon Key');
                    return;
                }
                
                // ä¿®å¤ï¼šæ£€æŸ¥ window.supabase æ˜¯å¦åŠ è½½æˆåŠŸ
                if (!window.supabase || !window.supabase.createClient) {
                    alert("Supabase åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ›´æ¢ CDNã€‚");
                    return;
                }

                try {
                    supabase = window.supabase.createClient(supabaseUrl.value, supabaseKey.value);
                    const { data, error } = await supabase
                        .from('user_data')
                        .select('*')
                        .eq('id', 1)
                        .single();

                    // ä¿®å¤ï¼šPGRST116 (No rows found) ä¸ç®—è¿æ¥å¤±è´¥ï¼Œåªæ˜¯è¿˜æ²¡æ•°æ®
                    if (error && error.code !== 'PGRST116') {
                        console.error('Supabase Connect Error:', error);
                        syncStatus.value = 'è¿æ¥å¤±è´¥';
                        return;
                    }

                    if (data && data.projects) {
                        projects.value = data.projects;
                        // å¦‚æœäº‘ç«¯æœ‰æ•°æ®ï¼ŒåŒæ­¥å›æœ¬åœ°å­˜å‚¨
                        localStorage.setItem('ls_projects_v5', JSON.stringify(projects.value));
                    }
                    
                    syncStatus.value = 'å·²è¿æ¥';
                    // ç«‹å³è§¦å‘ä¸€æ¬¡ä¿å­˜ï¼Œç¡®ä¿å¦‚æœæ˜¯æ–°è¿æ¥ï¼ŒæŠŠæœ¬åœ°æ•°æ®æ¨ä¸Šå»
                    saveData();
                } catch(e) {
                    console.error('Init Exception:', e);
                    syncStatus.value = 'è¿æ¥å¤±è´¥';
                }
            };

            // --- Voice ---
            const isMicListening = ref(false); let recognition;
            const toggleMicForInsight = () => {
                if (!('webkitSpeechRecognition' in window)) return alert("éœ€ Chrome");
                if (isMicListening.value) { recognition.stop(); return; }
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.onstart = () => isMicListening.value = true;
                recognition.onend = () => isMicListening.value = false;
                recognition.onresult = (e) => tempInsight.value += e.results[0][0].transcript;
                recognition.start();
            };

            const isVoiceReviewing = ref(false); const voiceState = ref('idle'); const aiSpeakingText = ref(''); const synth = window.speechSynthesis; let coachRecog;
            const speak = (text, cb) => {
                if(synth.speaking) synth.cancel();
                aiSpeakingText.value = text;
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'zh-CN';
                u.onend = cb || null;
                synth.speak(u);
            };
            const startVoiceReview = () => {
                isVoiceReviewing.value = true;
                const todo = projects.value.flatMap(p=>p.actions).find(a=>!a.done);
                if(todo) speak(`å…³äº "${todo.title}"ï¼Œé‡åˆ°ä»€ä¹ˆé—®é¢˜äº†å—ï¼Ÿ`, toggleCoachMic);
                else speak("ä»Šå¤©ä»»åŠ¡éƒ½å®Œæˆäº†ï¼ŒçœŸæ£’ï¼æœ‰ä»€ä¹ˆæƒ³è®°å½•çš„å—ï¼Ÿ", toggleCoachMic);
            };
            const toggleCoachMic = () => {
                if(voiceState.value==='listening') { coachRecog.stop(); return; }
                coachRecog = new webkitSpeechRecognition();
                coachRecog.lang='zh-CN';
                coachRecog.onstart=()=>voiceState.value='listening';
                coachRecog.onend=()=>voiceState.value='idle';
                coachRecog.onresult=async(e)=>{
                    const text=e.results[0][0].transcript;
                    voiceState.value='thinking';
                    aiSpeakingText.value='åˆ†æä¸­...';
                    const res = await callAI([{role:"user", content:`ç”¨æˆ·å¤ç›˜è¯´: ${text}ã€‚è¯·ç®€çŸ­é¼“åŠ±ã€‚`}]);
                    speak(res||"å·²è®°å½•ã€‚", null);
                };
                coachRecog.start();
            };
            const endVoiceReview = () => {
                isVoiceReviewing.value=false;
                synth.cancel();
                if(coachRecog) coachRecog.stop();
            };

            // ç”Ÿå‘½å‘¨æœŸï¼šè‡ªåŠ¨å°è¯•æ¢å¤ Supabase è¿æ¥
            onMounted(() => {
                if(supabaseUrl.value && supabaseKey.value) {
                    initSupabase();
                }
            });

            // ä»»ä½•ç›¸å…³å­—æ®µå˜åŒ–éƒ½è§¦å‘ä¿å­˜ï¼ˆæœ¬åœ° + å¯èƒ½çš„äº‘ç«¯ï¼‰
            watch(
                [projects, apiKey, apiBaseUrl, apiModel, supabaseUrl, supabaseKey],
                () => { saveData(); },
                { deep: true }
            );

            return {
                currentView, detailTab, projects, activeProject, activeAction,
                showPlanningModal, showInsightModal, isEditing, planInput,
                planningMessages, isThinking, tempInsight, syncStatus,
                todayDate, getProgress, getPendingCount, getDoneActions,
                openProject, toggleEdit, markDone, saveInsight, replenishInsight,
                deleteAction, startPlanning, closePlanning, sendPlanningMessage,
                finalizePlan, initSupabase, apiKey, apiBaseUrl, apiModel,
                supabaseUrl, supabaseKey, isMicListening, toggleMicForInsight,
                isVoiceReviewing, voiceState, aiSpeakingText, startVoiceReview,
                endVoiceReview, toggleCoachMic, resetData
            };
        }
    }).mount('#app');
</script>
</body>
</html>
