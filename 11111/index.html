<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LifeOS V2.0 | AI é•¿æœŸä¸»ä¹‰ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥ Supabase å®¢æˆ·ç«¯ (ä¸ºäº‘ç«¯åŒæ­¥åšå‡†å¤‡) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .mic-active { animation: pulse 1.5s infinite; background-color: #ef4444 !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col md:flex-row text-slate-800">

    <div id="app" class="w-full h-full flex flex-col md:flex-row relative">
        
        <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨å¯¼èˆª -->
        <div class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center z-50">
            <span class="font-bold text-lg tracking-wider">LifeOS <span class="text-emerald-400">AI</span></span>
            <button @click="showMobileMenu = !showMobileMenu" class="text-2xl">â˜°</button>
        </div>

        <!-- ä¾§è¾¹æ  (PC/Mobile) -->
        <aside :class="{'translate-x-0': showMobileMenu, '-translate-x-full': !showMobileMenu}" 
               class="absolute md:relative z-40 w-64 h-full bg-slate-900 text-white transition-transform duration-300 md:translate-x-0 flex flex-col justify-between shadow-2xl">
            <div>
                <div class="p-8 font-bold text-2xl tracking-wider hidden md:block">
                    LifeOS <span class="text-emerald-400">V2</span>
                </div>
                <nav class="flex flex-col gap-2 p-4">
                    <template v-for="item in menuItems" :key="item.id">
                        <button @click="currentTab = item.id; showMobileMenu = false" 
                            :class="{'bg-emerald-600 shadow-lg shadow-emerald-900/50': currentTab===item.id, 'hover:bg-slate-800': currentTab!==item.id}" 
                            class="p-4 rounded-xl flex items-center gap-4 transition-all duration-200">
                            <span class="text-xl">{{ item.icon }}</span> 
                            <span class="font-medium">{{ item.name }}</span>
                        </button>
                    </template>
                </nav>
            </div>
            
            <!-- åº•éƒ¨çŠ¶æ€åŒº -->
            <div class="p-6 border-t border-slate-700 bg-slate-950/50">
                <div class="flex items-center gap-2 text-xs text-slate-400 mb-2">
                    <span class="w-2 h-2 rounded-full" :class="isCloudSync ? 'bg-green-500' : 'bg-yellow-500'"></span>
                    {{ isCloudSync ? 'äº‘ç«¯å·²è¿æ¥ (Supabase)' : 'æœ¬åœ°æ¨¡å¼ (LocalStorage)' }}
                </div>
                <button @click="startDailyReview" class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 py-3 rounded-lg font-bold text-sm shadow-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                    <span>ğŸ™ï¸</span> å¼€å¯è¯­éŸ³å¤ç›˜
                </button>
            </div>
        </aside>

        <!-- ä¸»ç•Œé¢ -->
        <main class="flex-1 h-full overflow-hidden bg-slate-50 relative flex flex-col">
            
            <!-- é¡¶éƒ¨æ  -->
            <header class="bg-white/80 backdrop-blur border-b border-slate-200 p-4 md:p-6 flex justify-between items-center z-10">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">{{ getTabName(currentTab) }}</h2>
                    <p class="text-sm text-slate-500 hidden md:block" v-if="currentTab === 'dashboard'">"{{ dailyQuote }}"</p>
                </div>
                <div class="flex gap-3">
                     <!-- å¿«é€Ÿæ·»åŠ æŒ‰é’® -->
                    <button @click="showPlanModal = true" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm hover:bg-slate-700 transition flex items-center gap-2">
                        <span>âœ¨</span> <span class="hidden md:inline">AI ç”Ÿæˆè®¡åˆ’</span>
                    </button>
                </div>
            </header>

            <!-- æ»šåŠ¨å†…å®¹åŒº -->
            <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 no-scrollbar scroll-smooth">
                
                <!-- 1. ä»ªè¡¨ç›˜ -->
                <div v-if="currentTab === 'dashboard'" class="space-y-8">
                    <!-- è¿›åº¦ç»Ÿè®¡ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <div class="text-slate-400 text-xs uppercase font-bold">ä»Šæ—¥å®Œæˆåº¦</div>
                            <div class="text-3xl font-black text-slate-800 mt-1">{{ completionRate }}%</div>
                        </div>
                         <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <div class="text-slate-400 text-xs uppercase font-bold">è¿èƒœå¤©æ•°</div>
                            <div class="text-3xl font-black text-orange-500 mt-1">ğŸ”¥ {{ maxStreak }}</div>
                        </div>
                    </div>

                    <!-- ä¹ æƒ¯å¡ç‰‡ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="(habit, idx) in habits" :key="idx" 
                             class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 transition-all hover:-translate-y-1 hover:shadow-xl group">
                            <div class="flex justify-between items-start">
                                <span class="text-4xl p-3 bg-slate-50 rounded-2xl">{{ habit.icon }}</span>
                                <button @click="toggleCheck(idx)" 
                                        :class="isCheckedToday(habit) ? 'bg-emerald-500 text-white rotate-0' : 'bg-slate-100 text-slate-300 -rotate-180'"
                                        class="w-10 h-10 rounded-full flex items-center justify-center transition-all duration-500 shadow-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                                    </svg>
                                </button>
                            </div>
                            <div class="mt-4">
                                <h3 class="font-bold text-lg text-slate-800">{{ habit.name }}</h3>
                                <p class="text-sm text-slate-400 mt-1 h-10 line-clamp-2">{{ habit.desc }}</p>
                            </div>
                            <!-- ç»‘å®šæœ€è¿‘ä¸€æ¬¡åé¦ˆ -->
                            <div v-if="habit.lastFeedback" class="mt-4 pt-3 border-t border-slate-100 text-xs text-slate-500 bg-slate-50 p-2 rounded">
                                ğŸ’¬ {{ habit.lastFeedback }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. AI åŠ©æ‰‹ (è¯­éŸ³ç‰ˆ) -->
                <div v-if="currentTab === 'chat'" class="h-full flex flex-col bg-white rounded-2xl shadow-sm overflow-hidden border border-slate-200">
                    <div class="flex-1 overflow-y-auto p-6 space-y-6" id="chat-box">
                        <div v-for="(msg, i) in chatHistory" :key="i" 
                             class="flex flex-col max-w-[85%]" 
                             :class="msg.role === 'user' ? 'self-end items-end' : 'self-start items-start'">
                            <div class="p-4 rounded-2xl text-sm leading-relaxed"
                                 :class="msg.role === 'user' ? 'bg-emerald-600 text-white rounded-tr-none' : 'bg-slate-100 text-slate-800 rounded-tl-none'">
                                <span v-html="renderMarkdown(msg.content)"></span>
                            </div>
                            <span class="text-[10px] text-slate-300 mt-1 px-1">{{ msg.time }}</span>
                        </div>
                        <div v-if="isThinking" class="self-start text-slate-400 text-sm animate-pulse pl-2">AI æ­£åœ¨æ€è€ƒå¹¶è§„åˆ’...</div>
                    </div>
                    
                    <!-- è¾“å…¥ä¸è¯­éŸ³æ§åˆ¶åŒº -->
                    <div class="p-4 bg-white border-t border-slate-100">
                        <div class="flex gap-2 items-center">
                            <button @click="toggleVoiceMode" :class="isVoiceActive ? 'mic-active text-white' : 'bg-slate-100 text-slate-600'" class="p-3 rounded-full transition-all">
                                ğŸ™ï¸
                            </button>
                            <input v-model="userInput" @keyup.enter="sendMessage" type="text" placeholder="è¾“å…¥é—®é¢˜æˆ–ä»»åŠ¡..." class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                            <button @click="sendMessage" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-emerald-700 transition">å‘é€</button>
                        </div>
                        <div v-if="voiceStatus" class="text-center text-xs text-emerald-600 mt-2 font-medium">{{ voiceStatus }}</div>
                    </div>
                </div>

                <!-- 3. è®¾ç½®/æ•°æ®æº -->
                <div v-if="currentTab === 'settings'" class="max-w-2xl mx-auto w-full">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 mb-6">
                        <h3 class="text-xl font-bold mb-6">â˜ï¸ è·¨è®¾å¤‡åŒæ­¥è®¾ç½® (Supabase)</h3>
                        <p class="text-sm text-slate-500 mb-4">ä¸ºäº†åœ¨æ‰‹æœºå’Œç”µè„‘é—´åŒæ­¥ï¼Œå¹¶è®© n8n èƒ½è¯»å–ä½ çš„è¿›åº¦ï¼Œè¯·å¡«å†™ Supabase ä¿¡æ¯ã€‚</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Supabase URL</label>
                                <input v-model="supabaseUrl" type="text" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Supabase Anon Key</label>
                                <input v-model="supabaseKey" type="password" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm">
                            </div>
                            <div class="flex gap-3">
                                <button @click="connectSupabase" class="flex-1 bg-slate-900 text-white py-2 rounded-lg text-sm hover:bg-slate-800">è¿æ¥æµ‹è¯• & åŒæ­¥</button>
                                <button @click="toggleCloudMode" class="px-4 py-2 border border-slate-300 rounded-lg text-sm">{{ isCloudSync ? 'åˆ‡æ¢å›æœ¬åœ°' : 'å¼ºåˆ¶æœ¬åœ°æ¨¡å¼' }}</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                         <h3 class="text-xl font-bold mb-4">ğŸ”‘ AI API è®¾ç½®</h3>
                         <input v-model="apiKey" type="password" placeholder="sk-..." class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm mb-2">
                         <input v-model="apiBaseUrl" type="text" placeholder="https://api.openai.com/v1" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm">
                    </div>
                </div>
            </div>
        </main>

        <!-- æ¨¡æ€æ¡†: AI è®¡åˆ’ç”Ÿæˆ -->
        <div v-if="showPlanModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
                <h3 class="text-xl font-bold mb-2">âœ¨ AI æ™ºèƒ½è§„åˆ’</h3>
                <p class="text-sm text-slate-500 mb-4">å‘Šè¯‰æˆ‘ä½ æƒ³å­¦ä»€ä¹ˆæˆ–åšä»€ä¹ˆï¼Œæˆ‘æ¥å¸®ä½ æ‹†è§£æˆæ¯æ—¥æ‰“å¡é¡¹ã€‚</p>
                <textarea v-model="planPrompt" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³åœ¨ä¸€ä¸ªæœˆå†…å­¦ä¼š n8n çš„åŸºç¡€æ“ä½œï¼Œæ¯å¤©å¤§æ¦‚æœ‰30åˆ†é’Ÿæ—¶é—´..." class="w-full h-32 bg-slate-50 rounded-xl p-4 text-sm mb-4 resize-none outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
                <div class="flex gap-3 justify-end">
                    <button @click="showPlanModal = false" class="text-slate-500 px-4 py-2 text-sm">å–æ¶ˆ</button>
                    <button @click="generatePlan" :disabled="isThinking" class="bg-emerald-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700">
                        {{ isThinking ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆè®¡åˆ’' }}
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // --- çŠ¶æ€ ---
                const currentTab = ref('dashboard');
                const showMobileMenu = ref(false);
                const showPlanModal = ref(false);
                const planPrompt = ref('');
                const userInput = ref('');
                const isThinking = ref(false);
                const voiceStatus = ref('');
                const isVoiceActive = ref(false);

                // æ•°æ®
                const menuItems = [
                    { id: 'dashboard', name: 'æ€»è§ˆ & æ‰“å¡', icon: 'ğŸ“Š' },
                    { id: 'chat', name: 'AI åŠ©æ‰‹', icon: 'ğŸ¤–' },
                    { id: 'settings', name: 'åŒæ­¥è®¾ç½®', icon: 'âš™ï¸' }
                ];
                
                // æœ¬åœ°/äº‘ç«¯ é…ç½®
                const apiKey = ref(localStorage.getItem('ls_apiKey') || '');
                const apiBaseUrl = ref(localStorage.getItem('ls_apiBaseUrl') || 'https://api.openai.com/v1');
                const supabaseUrl = ref(localStorage.getItem('ls_sbUrl') || '');
                const supabaseKey = ref(localStorage.getItem('ls_sbKey') || '');
                const isCloudSync = ref(false);
                let supabase = null;

                // æ ¸å¿ƒæ•°æ®
                const defaultHabits = [
                    { id: 1, name: 'å¥èº«', desc: 'æ ¸å¿ƒåŠ›é‡è®­ç»ƒ', icon: 'ğŸ’ª', history: [], lastFeedback: '' },
                    { id: 2, name: 'n8n å­¦ä¹ ', desc: 'æ„å»ºä¸€ä¸ªè‡ªåŠ¨åŒ–æµ', icon: 'âš¡', history: [], lastFeedback: '' }
                ];
                const habits = ref(JSON.parse(localStorage.getItem('ls_habits')) || defaultHabits);
                const chatHistory = ref(JSON.parse(localStorage.getItem('ls_chat')) || []);

                // æ¯æ—¥åè¨€
                const quotes = ["åšæŒæ¯”å®Œç¾æ›´é‡è¦ã€‚", "ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨ã€‚", "ä¸è¦å‡è£…åŠªåŠ›ï¼Œç»“æœä¸ä¼šé™ªä½ æ¼”æˆã€‚"];
                const dailyQuote = ref(quotes[Math.floor(Math.random() * quotes.length)]);

                // --- è¯­éŸ³è¯†åˆ«ä¸åˆæˆ (Web Speech API) ---
                let recognition = null;
                const synth = window.speechSynthesis;

                const initVoice = () => {
                    if ('webkitSpeechRecognition' in window) {
                        recognition = new webkitSpeechRecognition();
                        recognition.continuous = false;
                        recognition.lang = 'zh-CN';
                        recognition.onstart = () => { voiceStatus.value = 'æ­£åœ¨å¬...'; };
                        recognition.onend = () => { voiceStatus.value = ''; isVoiceActive.value = false; };
                        recognition.onresult = (event) => {
                            const transcript = event.results[0][0].transcript;
                            userInput.value = transcript;
                            sendMessage(); // å¬åˆ°åç›´æ¥å‘é€
                        };
                    } else {
                        alert("ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edgeã€‚");
                    }
                };

                const toggleVoiceMode = () => {
                    if (!recognition) initVoice();
                    if (isVoiceActive.value) {
                        recognition.stop();
                        isVoiceActive.value = false;
                    } else {
                        recognition.start();
                        isVoiceActive.value = true;
                    }
                };

                const speak = (text) => {
                    if (synth.speaking) synth.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN';
                    synth.speak(utterance);
                };

                // --- ä¸šåŠ¡é€»è¾‘ ---

                // 1. æ‰“å¡ä¸åé¦ˆç»‘å®š
                const isCheckedToday = (habit) => {
                    const today = new Date().toISOString().split('T')[0];
                    return habit.history.includes(today);
                };

                const toggleCheck = (idx) => {
                    const habit = habits.value[idx];
                    const today = new Date().toISOString().split('T')[0];
                    if (habit.history.includes(today)) {
                        habit.history = habit.history.filter(d => d !== today);
                    } else {
                        habit.history.push(today);
                        // è§¦å‘AIå¤¸å¥–
                        if(apiKey.value) quickAIReview(habit.name);
                    }
                    saveData();
                };

                // 2. AI æ ¸å¿ƒäº¤äº’
                const callAI = async (messages, jsonMode = false) => {
                    if (!apiKey.value) throw new Error("è¯·å…ˆè®¾ç½® API Key");
                    const response = await fetch(`${apiBaseUrl.value}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey.value}` },
                        body: JSON.stringify({
                            model: "gpt-3.5-turbo", // å¯æ¢ deepseek-chat
                            messages: messages,
                            response_format: jsonMode ? { type: "json_object" } : undefined
                        })
                    });
                    const data = await response.json();
                    return data.choices[0].message.content;
                };

                const sendMessage = async () => {
                    if (!userInput.value.trim()) return;
                    const text = userInput.value;
                    userInput.value = '';
                    chatHistory.value.push({ role: 'user', content: text, time: new Date().toLocaleTimeString() });
                    isThinking.value = true;
                    
                    try {
                        // æ„å»º Promptï¼šå¸¦ä¸Šå½“å‰çš„ä¹ æƒ¯çŠ¶æ€
                        const habitsState = habits.value.map(h => `${h.name}(${isCheckedToday(h)?'å·²å®Œæˆ':'æœªå®Œæˆ'}: ${h.lastFeedback})`).join(', ');
                        const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªé•¿æœŸä¸»ä¹‰æ•™ç»ƒã€‚ç”¨æˆ·çš„å½“å‰çŠ¶æ€ï¼š${habitsState}ã€‚
                        å¦‚æœç”¨æˆ·åœ¨è¿›è¡Œâ€œå¤ç›˜â€ï¼Œè¯·æ ¹æ®çŠ¶æ€æå‡ºå»ºè®®ã€‚
                        å¦‚æœç”¨æˆ·é—®å…³äº ${habits.value.map(h=>h.name).join(',')} çš„çŸ¥è¯†ï¼Œè¯·è§£ç­”ã€‚
                        å›ç­”è¦ç®€çŸ­æœ‰åŠ›ã€‚`;

                        const reply = await callAI([
                            { role: "system", content: systemPrompt },
                            ...chatHistory.value.slice(-5).map(m => ({role: m.role, content: m.content}))
                        ]);
                        
                        chatHistory.value.push({ role: 'assistant', content: reply, time: new Date().toLocaleTimeString() });
                        speak(reply); // AI è¯­éŸ³å›å¤

                    } catch (e) {
                        chatHistory.value.push({ role: 'assistant', content: "é”™è¯¯: " + e.message, time: '' });
                    } finally {
                        isThinking.value = false;
                        saveData();
                    }
                };

                // 3. è¯­éŸ³å¤ç›˜æ¨¡å¼ (Interactive Interview)
                const startDailyReview = async () => {
                    currentTab.value = 'chat';
                    const unfinished = habits.value.filter(h => !isCheckedToday(h)).map(h => h.name);
                    let prompt = "";
                    if (unfinished.length > 0) {
                        prompt = `å˜¿ï¼Œæˆ‘çœ‹ä½ ä»Šå¤©è¿˜æ²¡æœ‰å®Œæˆ ${unfinished.join(' å’Œ ')}ã€‚å‘ç”Ÿäº†ä»€ä¹ˆå›°éš¾å—ï¼Ÿè¿˜æ˜¯å‡†å¤‡ç°åœ¨å¼€å§‹ï¼Ÿ`;
                    } else {
                        prompt = "å“‡ï¼ä½ ä»Šå¤©ä»»åŠ¡å…¨ç»¿ï¼ä»Šå¤©åšè¿™äº›ä»»åŠ¡çš„æ—¶å€™ï¼Œæœ‰ä»€ä¹ˆç‰¹åˆ«çš„æ”¶è·æƒ³è®°å½•ä¸‹æ¥å—ï¼Ÿ";
                    }
                    chatHistory.value.push({ role: 'assistant', content: prompt, time: new Date().toLocaleTimeString() });
                    speak(prompt);
                    // è‡ªåŠ¨å¼€å¯å¬å†™
                    setTimeout(() => toggleVoiceMode(), 3000); 
                };

                // 4. AI ç”Ÿæˆè®¡åˆ’
                const generatePlan = async () => {
                    if (!planPrompt.value) return;
                    isThinking.value = true;
                    try {
                        const prompt = `ç”¨æˆ·ç›®æ ‡ï¼š${planPrompt.value}ã€‚è¯·æ‹†è§£ä¸º1-3ä¸ªå…·ä½“çš„æ¯æ—¥é‡å¤ä¹ æƒ¯ã€‚
                        å¿…é¡»è¿”å›çº¯ JSON æ ¼å¼ï¼š{"habits": [{"name": "ç®€çŸ­åç§°", "desc": "å…·ä½“æ‰§è¡ŒåŠ¨ä½œ", "icon": "emoji"}]}`;
                        
                        const jsonStr = await callAI([{ role: "system", content: "ä½ æ˜¯ä¸€ä¸ªè®¡åˆ’è§„åˆ’å¸ˆï¼Œåªè¾“å‡ºJSONã€‚" }, { role: "user", content: prompt }], true);
                        const result = JSON.parse(jsonStr);
                        
                        result.habits.forEach(h => {
                            habits.value.push({ ...h, history: [], lastFeedback: '' });
                        });
                        showPlanModal.value = false;
                        planPrompt.value = '';
                        alert(`å·²æ·»åŠ  ${result.habits.length} ä¸ªæ–°ä¹ æƒ¯ï¼`);
                    } catch (e) {
                        alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API è®¾ç½®");
                    } finally {
                        isThinking.value = false;
                        saveData();
                    }
                };

                // ç®€å•çš„æ‰“å¡å³æ—¶åé¦ˆ
                const quickAIReview = async (habitName) => {
                    try {
                        const cheer = await callAI([{role: "system", content: "ä¸€å¥è¯å¤¸å¥–ç”¨æˆ·å®Œæˆäº†ä»»åŠ¡ï¼Œå¹½é»˜ä¸€ç‚¹ã€‚"}, {role: "user", content: `æˆ‘å®Œæˆäº† ${habitName}`}]);
                        // å°†åé¦ˆç»‘å®šåˆ°ä¹ æƒ¯ä¸Š
                        const h = habits.value.find(i => i.name === habitName);
                        if(h) h.lastFeedback = cheer;
                    } catch(e) {}
                };

                // --- æ•°æ®ä¸åŒæ­¥ ---
                const connectSupabase = async () => {
                    if(!supabaseUrl.value || !supabaseKey.value) return;
                    try {
                        supabase = window.supabase.createClient(supabaseUrl.value, supabaseKey.value);
                        const { data, error } = await supabase.from('user_data').select('*').limit(1);
                        if (!error) {
                            isCloudSync.value = true;
                            // ç®€å•çš„åˆå¹¶é€»è¾‘ï¼šå¦‚æœæœ‰äº‘ç«¯æ•°æ®ï¼Œè¦†ç›–æœ¬åœ°
                            if(data && data.length > 0) {
                                habits.value = data[0].habits;
                                chatHistory.value = data[0].chat_history;
                            }
                            localStorage.setItem('ls_sbUrl', supabaseUrl.value);
                            localStorage.setItem('ls_sbKey', supabaseKey.value);
                            alert("â˜ï¸ äº‘ç«¯è¿æ¥æˆåŠŸï¼");
                        } else {
                            throw error;
                        }
                    } catch (e) {
                        alert("è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ URL å’Œ Keyã€‚éœ€å…ˆåœ¨ Supabase å»ºè¡¨ã€‚");
                    }
                };

                const saveData = async () => {
                    // 1. æœ¬åœ°ä¿å­˜
                    localStorage.setItem('ls_habits', JSON.stringify(habits.value));
                    localStorage.setItem('ls_chat', JSON.stringify(chatHistory.value));
                    
                    // 2. äº‘ç«¯ä¿å­˜ (å¦‚æœå·²è¿æ¥)
                    if (isCloudSync.value && supabase) {
                        // å‡è®¾æœ‰ä¸€ä¸ªè¡¨ user_dataï¼Œid=1 æ˜¯å½“å‰ç”¨æˆ·
                        await supabase.from('user_data').upsert({ 
                            id: 1, 
                            habits: habits.value, 
                            chat_history: chatHistory.value,
                            updated_at: new Date()
                        });
                    }
                };

                // å·¥å…·å‡½æ•°
                const renderMarkdown = (text) => marked.parse(text);
                const getTabName = (id) => menuItems.find(i => i.id === id).name;
                const completionRate = computed(() => {
                    if(habits.value.length === 0) return 0;
                    const done = habits.value.filter(h => isCheckedToday(h)).length;
                    return Math.round((done / habits.value.length) * 100);
                });
                const maxStreak = computed(() => {
                    // ç®€å•è®¡ç®—æ‰€æœ‰ä¹ æƒ¯ä¸­æœ€é•¿çš„å†å²é•¿åº¦
                    return Math.max(0, ...habits.value.map(h => h.history.length));
                });

                watch([apiKey, apiBaseUrl], () => {
                    localStorage.setItem('ls_apiKey', apiKey.value);
                    localStorage.setItem('ls_apiBaseUrl', apiBaseUrl.value);
                });

                return {
                    currentTab, menuItems, getTabName, showMobileMenu,
                    habits, isCheckedToday, toggleCheck,
                    chatHistory, userInput, sendMessage, isThinking, renderMarkdown,
                    dailyQuote, startDailyReview, voiceStatus, isVoiceActive, toggleVoiceMode,
                    showPlanModal, planPrompt, generatePlan,
                    completionRate, maxStreak,
                    apiKey, apiBaseUrl, supabaseUrl, supabaseKey, connectSupabase, isCloudSync
                };
            }
        }).mount('#app');
    </script>
</body>
</html>